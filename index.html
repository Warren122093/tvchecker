<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>M3U8 / MPD ClearKey Checker & Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Shaka Player -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.15/shaka-player.compiled.js"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-md mx-auto p-6 bg-white/10 backdrop-blur rounded-2xl shadow-2xl border border-white/20">
    <h2 class="text-xl font-bold text-slate-100 mb-6 text-center tracking-wide">M3U8 / MPD ClearKey Checker &amp; Player</h2>
    <form id="checkForm" class="space-y-4">
      <div>
        <label for="url" class="block text-slate-300 text-sm font-semibold mb-1">Stream URL (M3U8 / MPD):</label>
        <input type="text" id="url" required placeholder="https://..." class="w-full px-4 py-2 rounded-lg border border-slate-700 bg-slate-800 text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition" autocomplete="off">
      </div>
      <div id="keyFields">
        <label for="keyid" class="block text-slate-300 text-sm font-semibold mb-1">Key ID (hex, e.g., 1a2b3c...):</label>
        <input type="text" id="keyid" placeholder="Key ID" class="w-full px-4 py-2 rounded-lg border border-slate-700 bg-slate-800 text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition" autocomplete="off">

        <label for="key" class="block text-slate-300 text-sm font-semibold mt-2 mb-1">Key (hex, e.g., 4d5e6f...):</label>
        <input type="text" id="key" placeholder="Key" class="w-full px-4 py-2 rounded-lg border border-slate-700 bg-slate-800 text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition" autocomplete="off">
      </div>
      <button type="submit" class="w-full py-3 rounded-lg bg-gradient-to-r from-cyan-400 to-blue-500 text-slate-900 font-bold text-lg shadow-lg hover:from-cyan-300 hover:to-blue-400 transition">Check &amp; Play</button>
    </form>
    <div id="message" class="mt-4 min-h-[32px] text-center text-base"></div>
    <video id="video" controls poster="" style="display:none" class="mt-6 w-full rounded-lg bg-black shadow-lg aspect-video"></video>
  </div>
  <script>
    const urlInput = document.getElementById('url');
    const keyFields = document.getElementById('keyFields');
    const keyidInput = document.getElementById('keyid');
    const keyInput = document.getElementById('key');
    const message = document.getElementById('message');
    const video = document.getElementById('video');
    let player; // Shaka player instance

    function updateKeyFields() {
      const url = urlInput.value.trim().toLowerCase();
      if (url.endsWith('.m3u8')) {
        keyFields.style.display = "none";
        keyidInput.required = false;
        keyInput.required = false;
      } else {
        keyFields.style.display = "";
        keyidInput.required = true;
        keyInput.required = true;
      }
    }
    urlInput.addEventListener('input', updateKeyFields);
    window.addEventListener('DOMContentLoaded', updateKeyFields);

    async function checkStream(url) {
      try {
        const r = await fetch(url, { method: 'HEAD' });
        return r.ok;
      } catch (e) {
        return false;
      }
    }
    function hexToBase64(hex) {
      return btoa(hex.match(/\w{2}/g).map(a => String.fromCharCode(parseInt(a, 16))).join(''));
    }

    function showMsg(msg, color) {
      message.textContent = msg;
      message.className = "mt-4 min-h-[32px] text-center text-base font-semibold " + color;
    }

    function destroyPlayer() {
      if (player) {
        player.destroy();
        player = null;
      }
      video.removeAttribute('src');
      video.load();
      video.style.display = "none";
    }

    // Show video only when really playing
    function showVideo() {
      video.style.display = 'block';
    }

    document.getElementById('checkForm').onsubmit = async function(e) {
      e.preventDefault();
      destroyPlayer();

      const url = urlInput.value.trim();
      const isM3U8 = url.toLowerCase().endsWith('.m3u8');
      const isMPD = url.toLowerCase().endsWith('.mpd');
      const keyid = keyidInput.value.replace(/[^a-fA-F0-9]/g, '');
      const key = keyInput.value.replace(/[^a-fA-F0-9]/g, '');

      showMsg("", "");

      if (!/^https?:\/\/.+/.test(url) || (!isM3U8 && !isMPD)) {
        showMsg("Invalid stream URL. Must be .m3u8 or .mpd.", "text-red-400");
        return;
      }
      if (isMPD && (keyid.length !== 32 && keyid.length !== 16)) {
        showMsg("Key ID must be 16 or 32 hex characters.", "text-red-400");
        return;
      }
      if (isMPD && (key.length !== 32 && key.length !== 16)) {
        showMsg("Key must be 16 or 32 hex characters.", "text-red-400");
        return;
      }

      showMsg("Checking stream URL...", "text-blue-300");
      const valid = await checkStream(url);
      if (!valid) {
        showMsg("Failed to access stream URL (CORS, geo, or offline?).", "text-red-400");
        return;
      }

      showMsg("Stream URL is valid. Initializing player...", "text-green-400");

      player = new shaka.Player(video);

      // Shaka error listener
      player.addEventListener('error', function(event) {
        showMsg("Shaka Error: " + (event.detail ? event.detail.code : JSON.stringify(event)), "text-red-400");
        destroyPlayer();
      });

      // Configure DRM for DASH, not for HLS
      if (isMPD) {
        player.configure({
          drm: {
            clearKeys: {
              [hexToBase64(keyid)]: hexToBase64(key)
            }
          }
        });
      } else {
        player.configure({drm: {clearKeys: {}}});
      }

      try {
        await player.load(url);
        showMsg("Playing stream!", "text-green-400");
        showVideo();
        // Try to play automatically on success
        try { video.play(); } catch { /* ignore */ }
      } catch (err) {
        showMsg("Player error: " + (err && err.message ? err.message : err), "text-red-400");
        destroyPlayer();
      }
    }
  </script>
</body>
</html>
